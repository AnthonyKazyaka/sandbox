# Deploy feature branch to GitHub Pages preview
name: Deploy Branch Preview to Pages

on:
  push:
    branches:
      - '**'
      - '!main'
      - '!master'

  # Allows manual trigger from Actions tab
  workflow_dispatch:

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment per branch
concurrency:
  group: "pages-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  deploy-preview:
    # Use environment for manual approval
    environment:
      name: branch-preview
      url: ${{ steps.deployment.outputs.page_url }}${{ steps.prepare.outputs.branch_path }}

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare branch path
        id: prepare
        run: |
          # Extract branch name and create safe path
          BRANCH_NAME="${{ github.ref_name }}"
          # Replace slashes with dashes for URL safety
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          echo "branch_path=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "Deploying to path: $SAFE_BRANCH"

      - name: Create deployment directory
        run: |
          SAFE_BRANCH="${{ steps.prepare.outputs.branch_path }}"
          mkdir -p deploy/$SAFE_BRANCH
          cp -r gps-admin/* deploy/$SAFE_BRANCH/

      - name: Generate config with Client ID
        run: |
          SAFE_BRANCH="${{ steps.prepare.outputs.branch_path }}"
          cat > deploy/$SAFE_BRANCH/config.local.js << 'EOF'
          /**
           * GPS Admin Configuration - Auto-generated by GitHub Actions
           * DO NOT EDIT - This file is automatically created during deployment
           */

          window.GPSConfig = {
              // Google Calendar OAuth 2.0 Client ID (injected from GitHub Secrets)
              calendar: {
                  clientId: '${{ secrets.GOOGLE_CALENDAR_CLIENT_ID }}',
              },

              // Google Maps API Key (optional, for travel time calculations)
              maps: {
                  apiKey: '',
              },

              // Application Settings
              app: {
                  // Disable mock data in production
                  useMockData: false,

                  // Production mode
                  debug: false,
              }
          };
          EOF

          # Create an index.html at root that lists all branch previews
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>GPS Admin - Branch Previews</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: #f5f5f5;
                  }
                  h1 { color: #333; }
                  .branch-list {
                      background: white;
                      border-radius: 8px;
                      padding: 20px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .branch-link {
                      display: block;
                      padding: 12px;
                      margin: 8px 0;
                      background: #4F46E5;
                      color: white;
                      text-decoration: none;
                      border-radius: 4px;
                      transition: background 0.2s;
                  }
                  .branch-link:hover {
                      background: #4338CA;
                  }
              </style>
          </head>
          <body>
              <h1>üêæ GPS Admin - Branch Previews</h1>
              <div class="branch-list">
                  <h2>Available Previews:</h2>
                  <a href="./$SAFE_BRANCH/" class="branch-link">
                      üì¶ Branch: ${{ github.ref_name }}
                  </a>
                  <p style="margin-top: 20px; color: #666; font-size: 0.875rem;">
                      Preview URL: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
                      ${{ steps.deployment.outputs.page_url }}$SAFE_BRANCH/
                      </code>
                  </p>
              </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output preview URL
        run: |
          PREVIEW_URL="${{ steps.deployment.outputs.page_url }}${{ steps.prepare.outputs.branch_path }}"
          echo "::notice title=Preview Deployed::Branch preview available at: $PREVIEW_URL"
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
